#!/bin/bash

# Script de dÃ©ploiement automatisÃ© via SSH/SFTP
# Copiez ce fichier en deploy-ssh.sh et configurez vos paramÃ¨tres

# âš ï¸ CONFIGURATION REQUISE âš ï¸
# Remplacez les valeurs ci-dessous par vos informations O2Switch

# Votre username O2Switch
SERVER_USER="votre_username"

# Votre serveur O2Switch (exemple: ns123456.o2switch.net)
SERVER_HOST="votreserveur.o2switch.net"

# Chemin distant (gÃ©nÃ©ralement ~/public_html/)
REMOTE_DIR="~/public_html/"

# Couleurs pour les messages
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NE MODIFIEZ PAS EN DESSOUS DE CETTE LIGNE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# VÃ©rification de la configuration
if [ "$SERVER_USER" = "votre_username" ] || [ "$SERVER_HOST" = "votreserveur.o2switch.net" ]; then
    echo -e "${RED}âŒ Erreur : Veuillez configurer vos identifiants dans ce script${NC}"
    echo -e "${YELLOW}ğŸ“ Ã‰ditez le fichier et remplacez :${NC}"
    echo "   - SERVER_USER par votre username O2Switch"
    echo "   - SERVER_HOST par votre serveur O2Switch"
    exit 1
fi

SERVER="$SERVER_USER@$SERVER_HOST"

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}ğŸš€ DÃ©ploiement automatisÃ© sur O2Switch${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Installation des dÃ©pendances si nÃ©cessaire
if [ ! -d "node_modules" ]; then
    echo -e "${BLUE}ğŸ“¥ Installation des dÃ©pendances...${NC}"
    npm install
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ Erreur lors de l'installation des dÃ©pendances${NC}"
        exit 1
    fi
fi

# Build du projet
echo -e "${BLUE}ğŸ”¨ Build du projet...${NC}"
npm run build

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Erreur lors du build${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… Build rÃ©ussi !${NC}"
echo ""

# Backup distant (optionnel)
echo -e "${BLUE}ğŸ’¾ CrÃ©ation d'un backup du site actuel...${NC}"
ssh $SERVER "cd public_html && tar -czf ../backup-$(date +%Y%m%d-%H%M%S).tar.gz . 2>/dev/null || true"

# Upload via rsync
echo -e "${BLUE}ğŸ“¤ Upload vers O2Switch...${NC}"
echo -e "${YELLOW}Serveur: $SERVER${NC}"
echo ""

rsync -avz --delete \
  --exclude='.htpasswd' \
  --exclude='cgi-bin' \
  --exclude='error_log' \
  dist/ $SERVER:$REMOTE_DIR

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Erreur lors de l'upload${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ VÃ©rifiez que :${NC}"
    echo "   - Votre connexion SSH est configurÃ©e"
    echo "   - Vos identifiants sont corrects"
    echo "   - SSH est activÃ© sur votre compte O2Switch"
    exit 1
fi

echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ… DÃ©ploiement rÃ©ussi !${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${BLUE}ğŸŒ Votre site est maintenant en ligne${NC}"
echo ""
echo -e "${YELLOW}ğŸ“‹ VÃ©rifiez votre site :${NC}"
echo "   â†’ https://votredomaine.com"
echo ""
echo -e "${YELLOW}ğŸ’¾ Un backup a Ã©tÃ© crÃ©Ã© sur le serveur${NC}"
echo ""
